#!/usr/bin/env bash
if [ "$CODESPACES" = "true" ]; then
  echo "In a Codespaces instance. Adding Codespaces-specific settings."

  # Source my dotfiles for zsh.
  echo "source /workspaces/.codespaces/.persistedshare/dotfiles/codespacesrc" >> $HOME/.zshrc

  # Add repo access to npmrc
  # https://github.com/customink/ndx/blob/da294f6eb1a66ec17509e434bbecb8ba80ed4fa8/docs/development.md#authentication-for-private-packages
  echo "//npm.pkg.github.com/:_authToken=${CI_GH_AUTH}" >> $HOME/.npmrc
  chmod 600 $HOME/.npmrc

  # Add repo access for Ruby (copy so secrets can be added without polluting the git repo)
  cp /workspaces/.codespaces/.persistedshare/dotfiles/codespaces/netrc $HOME/.netrc
  sed -i -e "s/<auth>/${CI_GH_AUTH}/g" $HOME/.netrc
  chmod 600 $HOME/.netrc

else
  echo "Copying main ZSH RC"
  cp ../zshrc $HOME/.zshrc

  if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "Looks like we're running on a Mac. Adding Mac-specific things."

    # This should detect if it's a work machine, based on an env variable set by Strap, which is how this is getting called
    if [ -n $CUSTOM_BREW_COMMAND ]; then
      echo "This machine is for work. Setting up work-specific things."

      echo "source ~/.dotfiles/zsh/work" >> $HOME/.zshrc
    else
      echo "Not a work machine. Setting up generic Mac stuff."

      echo "source ~/.dotfiles/zsh/darwin" >> ~/.zshrc
    fi
  fi
fi
